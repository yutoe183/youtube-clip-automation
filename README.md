# youtube-clip-automation
YouTube切り抜き動画の自動生成ツール

## 概要
YouTubeのライブ配信アーカイブの切り抜き動画を自動生成します。具体的には、以下の手順を自動化します。

- ライブ配信のアーカイブからチャットとコメントを取得
- 特定のキーワードに該当するチャットとコメントを抽出
- 該当の動画をダウンロード
- 動画編集(切り抜き、結合)

手動で実施する必要のある処理は以下です。

- 切り抜き候補を実際の動画で確認し、切り抜き開始時刻と終了時刻を正確に指定

### パッケージ
以下のPythonパッケージを利用しています。

- yt-dlp
- moviepy

## 使い方
### 対応環境
Linux  
Python3

#### 動作確認環境
OS: Ubuntu22.04LTS / WSL2  
Python: 3.10.12, 3.12.1, 3.12.2

### 環境構築
#### 1. パッケージのインストール

```source setup.sh```

Pythonのバージョンを指定する場合 (例: Python3.12)  
```source setup.sh 3.12```

#### 2. ImageMagickのセキュリティポリシー変更

`/etc/ImageMagick-6/policy.xml` の91行目を以下のように変更します。(`none` を `read|write` に変更)

変更前: `<policy domain="path" rights="none" pattern="@*"/>`  
変更後: `<policy domain="path" rights="read|write" pattern="@*"/>`

上記変更にroot権限が必要な場合、例えば ```sudo vi /etc/ImageMagick-6/policy.xml``` のように`sudo`で実行してください。

これにより、MoviePyの `TextClip` が実行できるようになります。

### 使用手順
#### 1. チャットの取得、抽出、クラスタリング
```source src/chat.sh 作成するディレクトリのパス YouTubeのチャンネルID 検索文字列(厳しめ) 検索文字列(緩め) 取得開始日(YYYYMMDD) 取得終了日(YYYYMMDD)```

- 必須引数(2個): 作成するディレクトリのパス YouTubeのチャンネルID
- 任意引数(4個): 検索文字列(厳しめ) 検索文字列(緩め) 取得開始日(YYYYMMDD) 取得終了日(YYYYMMDD)

作成するディレクトリのパスは任意です。(例: `data/20240510_example`)  
検索文字列は正規表現で記述可能です。この文字列は、切り抜き候補の絞り込みに使われます。  
取得開始日から取得終了日までに投稿された動画が切り抜きの対象になります。

切り抜き箇所の候補は `作成したディレクトリのパス/extract/results.txt` に出力されます。

また、「動画ID 日付 タイトル」のリストが `作成したディレクトリのパス/extract/list_date_title.txt` に出力されます。

なお、検索文字列を指定しない場合、`results.txt` と `list_date_title.txt` は作成されず、チャットデータのダウンロードのみが実行されます。  
検索文字列(厳しめ)のみを指定した場合、検索文字列(緩め)に同じ文字列を指定した場合と同じように動作します。

##### 検索文字列の説明
検索文字列(厳しめ)を含むチャットが存在する時刻付近を切り抜き候補とします。  
また、おまけ的な機能として、付近の検索文字列(緩め)を含むチャット数やスーパーチャット金額を集計した値が動画内に表示されます。  
上記チャット間の時間間隔が短い場合、それらをひとまとめにして1箇所の候補とします。

##### 検索文字列の変更
異なる検索文字列で切り抜き箇所の候補を出力したい場合、再度 `chat.sh` を実行します。

`作成したディレクトリのパス/live_chat/` ディレクトリが既に存在する場合、チャットデータのダウンロードはスキップされます。  
この場合、コマンドの第2引数(YouTubeのチャンネルID)は無視されるため、何らかの適当な文字列を指定します。

ただし、`results.txt` が誤って上書きされることを防ぐため、`作成したディレクトリのパス/extract/results.txt` が既に存在する場合は `results.txt` と `list_date_title.txt` は作成されません。  
新たに作成する場合は既存の `results.txt` を削除するか名前変更します。

#### 2. 実際にYouTubeで確認、results.txtを編集
`results.txt` の各行には、切り抜き候補の以下の情報が空白区切りで記載されます。

`動画URL` `該当チャット数(コメント数)` `スパチャ金額` `開始時刻` `終了時刻` `公開日` `チャット例...(最大24個)`

`results.txt` 内の候補のうち、切り抜きに使用する動画について以下の編集をします。

1. 開始時刻と終了時刻を切り抜き部分に一致するように修正
1. 行の先頭に一文字追記 (例えば `-` など)
1. (任意) 並び順を変更
1. (任意) 行を複製して編集
1. (任意) 公開日文字列、チャット数、スパチャ金額を編集

先頭を変更した行の切り抜き動画が上から順に結合されます。動画順序を変更したい場合は行の順序を変更します。(デフォルトは投稿日順)  
1箇所の候補周辺で複数の切り抜きを作成したい場合、その行を複製し、それぞれの行で開始時刻と終了時刻を編集します。  
公開日は単に動画内に表示する情報なので、任意の文字列に変更することができます。その場合、変更後の文字列が動画に表示されます。チャット数やスーパーチャット金額も同様です。

動画URLは、該当チャットが初めて出現する時刻の30秒前から再生されるようにパラメータが指定されています。

#### 3. 動画ダウンロード、動画編集 (、チャット数とスパチャ額集計)
```source src/video.sh 作成したディレクトリのパス 検索文字列 -d```

- 必須引数(1個): 作成したディレクトリのパス
- 任意引数(1個): -d

検索文字列は正規表現で記述可能です。
この文字列は、スーパーチャットやチャットの集計に使われます。  
`-d` を指定すると、切り抜き作成後に元動画を削除します。ダウンロード、切り抜き作成、元動画削除という一連の流れが各動画ごとに実行されます。

ダウンロードされた動画は、 `作成したディレクトリのパス/download/` 内に保存されます。  
各切り抜きは、 `作成したディレクトリのパス/clip/` 内に保存されます。  
完成動画は `作成したディレクトリのパス/dst/clip.mp4` に出力されます。  
タイムスタンプは `作成したディレクトリのパス/dst/timestamp.txt` に出力されます。

##### 切り抜き箇所の修正
切り抜きのタイミングをずらしたい場合、以下の手順で修正できます。

1. `results.txt` の開始時刻と終了時刻を修正
1. 手順3のコマンドを再度実行 `source src/video.sh 作成したディレクトリのパス`

#### その他
本ツールでは処理するデータ量が非常に大きいため、ストレージ容量を圧迫する可能性があります。  
その場合、外付けHDD等を使用することができます。

外部ストレージを使う場合、ここまでに出てきたディレクトリ名と同名のシンボリックリンクを作成すれば良いです。

例 (外部ストレージが `/mnt/d/` にマウントされている場合)  
```ln -s /mnt/d/example data/20240510_example```  
```ln -s /mnt/d/example data/20240510_example/download```

## 使用例、コード解説
詳細は以下の記事に記載しています。

[https://diary-039.com/entry/2024/02/20/youtube-clip-automation](https://diary-039.com/entry/2024/02/20/youtube-clip-automation)

## 更新履歴

| 日付 | ver. | 更新内容 |
| --- | --- | --- |
| 2024/05/19 | v1.1.0 | タイムスタンプの誤差が累積する問題の修正、表示日付を投稿日から公開日に変更、公開日を任意の文字列に編集できるよう変更(list_date_title.txtの必須化) |
| 2024/05/10 | v1.0.0 | 大幅改修(sum_superchat.pyの削除(video.shの検索文字列不要化)、文字列検索のpython完結化、results.txtへの全情報集約化、クラスタリングアルゴリズム一部変更(sum_superchat.py削除による、該当チャット直前数秒間のチャット取得のためのリングバッファ追加)、タイトル表示機能追加、切り抜き並べ替え対応、各切り抜き動画ファイル名のmsec化(時刻編集時に以前の切り抜きの削除不要化)、異なるアスペクト比の結合対応、ディレクトリのシンボリックリンク対応、円以外の通貨50種対応、results.txtの空白行許容対応、results.txtの上書き防止、ImageMagickとMoviePyのエラー回避、音のフェード対応) |
| 2024/03/10 | | コメントからの候補抽出機能追加、該当コメント数表示対応、時刻の小数対応 |
| 2024/02/27 | | チャットダウンロードのみの実行機能追加 |
| 2024/02/22 | | チャット取得時に前半の一部しか取得されない問題の修正、ダウンロード再試行回数指定機能追加、ダウンロード失敗時のエラー回避 |
| 2024/02/20 | | 初版として公開 |
| 2024/02/11 | | 簡易版完成、初試用 |
| 2024/02/10 | | 開発開始 |
