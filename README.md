# youtube-clip-automation
YouTube切り抜き動画の自動生成ツール

## 概要
YouTubeのライブ配信アーカイブの切り抜き動画を自動生成します。具体的には、以下の手順を自動化します。

- ライブ配信のアーカイブからチャットとコメントを取得
- 特定のキーワードに該当するチャットとコメントを抽出
- 該当の動画をダウンロード
- 切り抜きや結合を含む動画編集

手動で実施する必要のある処理は以下です。

- 切り抜き候補を実際の動画で確認し、切り抜き開始時刻と終了時刻を正確に指定

### 使用パッケージ
以下のPythonパッケージを利用しています。

- yt-dlp
- moviepy

## 使い方
### 対応環境
Linux  
Python3

#### 動作確認環境
OS: Ubuntu24.04.1 LTS / WSL2  
Python: 3.12.3

### 環境構築
#### 1. パッケージのインストール

```source setup.sh```

Pythonのバージョンを指定する場合 (例: Python3.12)  
```source setup.sh 3.12```

#### 2. 依存ファイル

本ツールは、本リポジトリ内の以下のファイルを参照します。必要があれば、自分用のファイルに置き換えてください。

- `src/font/MPLUSRounded1c-Regular.ttf` : 日本語対応のフォントです。`src/font/` ディレクトリ内のファイルをフォントファイルとして認識します。
- `src/auth/cookies.txt` : ログイン情報を含むNetscape形式のCookieファイルです。ダウンロードにログイン情報が必要な場合はCookieをブラウザ等から出力して置き換えます。このファイルは本ツールによって常に更新されます。

### 使用手順
#### 1. チャットの取得、抽出、クラスタリング
```source src/chat.sh 作成するディレクトリのパス YouTubeのチャンネルID 検索文字列(厳しめ) 検索文字列(緩め) 検索文字列(カウント用) 取得開始日(YYYYMMDD) 取得終了日(YYYYMMDD) オプション(-f: results.txtを強制上書きする場合)```

- 必須引数(2個): 作成するディレクトリのパス YouTubeのチャンネルID
- 任意引数(6個): 検索文字列(厳しめ) 検索文字列(緩め) 検索文字列(カウント用) 取得開始日(YYYYMMDD) 取得終了日(YYYYMMDD) オプション(-f: results.txtを強制上書きする場合)

作成するディレクトリのパスは任意です。(例: `data/20240510_example`)  
検索文字列は正規表現で記述可能です。この文字列は、切り抜き候補の絞り込みに使われます。  
取得開始日から取得終了日までに投稿された動画が切り抜きの対象になります。

切り抜き箇所の候補は `作成したディレクトリのパス/extract/results.txt` に出力されます。

また、「動画ID 日付 タイトル」のリストが `作成したディレクトリのパス/extract/list_date_title.txt` に出力されます。

なお、検索文字列を指定しない場合、`results.txt` と `list_date_title.txt` は作成されず、チャットデータのダウンロードのみが実行されます。  
検索文字列(厳しめ)のみを指定した場合、検索文字列(緩め)に同じ文字列を指定した場合と同じように動作します。

##### 検索文字列の説明
検索文字列(厳しめ)を含むチャットが1個以上存在、または、検索文字列(緩め)を含むチャットが4個以上存在する時刻付近を切り抜き候補とします。  
上記チャット間の時間間隔が短い場合、それらをひとまとめにして1箇所の候補とします。  
また、おまけ的な機能として、付近の検索文字列(カウント用)を含むチャット数やスーパーチャット金額を集計した値が動画内に表示されます。

##### 検索文字列の変更
異なる検索文字列で切り抜き箇所の候補を出力したい場合、再度 `chat.sh` を実行します。

`作成したディレクトリのパス/live_chat/` ディレクトリが既に存在する場合、存在しないチャットデータのみがダウンロードされます。

ただし、`results.txt` が誤って上書きされることを防ぐため、`作成したディレクトリのパス/extract/results.txt` が既に存在する場合は `results.txt` と `list_date_title.txt` は作成されません。  
新たに作成する場合は既存の `results.txt` を削除するか名前変更してから `chat.sh` を実行します。

#### 2. 実際にYouTubeで確認、results.txtを編集
`results.txt` の各行には、切り抜き候補の以下の情報が空白区切りで記載されます。

`動画URL` `該当チャット数(コメント数)` `スパチャ金額` `開始時刻` `終了時刻` `公開日` `チャット例...(最大24個)`

`results.txt` 内の候補のうち、切り抜きに使用する動画について以下の編集をします。  
詳しくは後述の「`results.txt` の記述例」

1. 開始時刻と終了時刻を切り抜き部分に一致するように修正
1. 行の先頭に文字を追記 (例えば、数字や `-` など)、または、開始時刻に続いて注目時刻を `,` 区切りで指定
1. (任意) 並び順を変更
1. (任意) 行を複製して編集
1. (任意) 公開日文字列、チャット数、スパチャ金額を編集
1. (任意) その他、後述のカスタマイズ

手順2の変更をした行の切り抜き動画が上から順に結合されます。動画順序を変更したい場合は行の順序を変更します。(デフォルトは投稿日順)  
1箇所の候補周辺で複数の切り抜きを作成したい場合、その行を複製し、それぞれの行で開始時刻と終了時刻を編集します。  
公開日は単に動画内に表示する情報なので、任意の文字列に変更することができます。その場合、変更後の文字列が動画に表示されます。チャット数やスーパーチャット金額も同様です。

動画URLは、該当チャットが初めて出現する時刻の15秒前から再生されるようにパラメータが指定されています。

おまけの機能として、行頭に数字を追記した場合、`results.txt` 内のすべての行頭の数字と、注目時刻の個数の合計値が標準出力されます。何らかのメモ機能として使うことを想定しています。  
標準出力の形式は以下の通りです。  
`count clip: 編集済み行数`  
`count memo: 上記のメモ合計値`

また、`results.txt` で使用できるタグには以下があります。

- `<counter=N> ... </counter>` : タグに挟まれた部分の動画内にカウンターを表示します。`=N` を指定すると、`N` からカウントします。指定しない場合、現在のカウントを引き継ぎます。ファイルの先頭では `N=0` です。
- `<category=STR/>` : 以降のカテゴリを `STR` にします。動画右上に表示され、タイムスタンプ内でカテゴリごとに採番されます。`=STR` を指定しない場合、空文字が指定されます。
- `<!-- ... -->` : タグに挟まれた部分をコメントアウトします。

ただし、タグを使う場合、1行にタグ1つのみを記述し、それ以外は何も書かないでください。  
また、タグを閉じない場合、ファイルの末尾ですべて閉じられているものだと評価されます。

##### results.txt の記述例
`chat.sh` によって、以下の `results.txt` が出力されたとします。
```
https://youtu.be/AAAAAAAAAAA?t=123s 3 0 0:02:23 0:02:40 2023/01/01 chat0 chat1
https://youtu.be/EEEEEEEEEEE?t=0s 1 0 0:00:00 0:00:00 2024/01/01 comment0
https://youtu.be/EEEEEEEEEEE?t=4800s 23 0 1:20:20 1:21:20 2024/01/01 chat0 chat1 chat2 chat3
https://youtu.be/IIIIIIIIIII?t=4200s 5 500 1:10:20 1:12:40 2024/01/01 chat0 chat1 chat2
https://youtu.be/IIIIIIIIIII?t=7200s 2 0 2:00:20 2:05:00 2024/01/01 chat0
https://youtu.be/IIIIIIIIIII?t=10800s 2 0 3:00:20 3:00:10 2024/01/01 chat0
```
上記の出力例では、2行目が該当コメント、それ以外は該当チャットが存在する箇所です。

この場合、例えば以下のように編集できます。
```
-https://youtu.be/AAAAAAAAAAA?t=123s 3 0 0:02:15 0:02:25 A1-1_2023/01/01 chat0 chat1
-https://youtu.be/AAAAAAAAAAA?t=123s 3 0 0:02:25 0:02:35 A1-2_2023/01/01 chat0 chat1
<!--
-https://youtu.be/AAAAAAAAAAA?t=123s 3 0 0:02:35 0:02:45 A1-3_2023/01/01 chat0 chat1
-https://youtu.be/AAAAAAAAAAA?t=123s 3 0 0:02:45 0:02:55 A1-4_2023/01/01 chat0 chat1
-->

<category=categoryX/>
https://youtu.be/EEEEEEEEEEE?t=0s 1 0 0:00:00 0:00:00 E0-1_2024/01/01 comment0
<counter=100>
https://youtu.be/EEEEEEEEEEE?t=4800s 23 0 1:20:10,15,30 1:20:35 E1-1_2024/01/01 chat0 chat1 chat2 chat3
https://youtu.be/IIIIIIIIIII?t=4200s 5 500 1:10:05,2,1205,11306 1:13:08 I1-1_2024/01/01 chat0 chat1 chat2
</counter>
5https://youtu.be/IIIIIIIIIII?t=7200s 2 0 2:00:20 2:05:00 I2-1_2024/01/01 chat0
https://youtu.be/IIIIIIIIIII?t=10800s 2 0 3:00:20 3:00:10 I3-1_2024/01/01 chat0

memo
<counter>
<category=/>
-https://youtu.be/AAAAAAAAAAA?t=123s 3 0 0:02:15,18 0:02:25 A1-5_2023/01/01 chat0 chat1
```

説明の都合上、それぞれの切り抜き箇所に、A1-1, A1-2 といった名前をつけています。

完成動画について、A1-1 の 0:02:15-0:02:25, A1-2 の 0:02:25-0:02:35, E1-1 の 1:20:10-1:20:35, I1-1 の 1:10:05-1:13:08, I2-1 の 2:00:20-2:05:00, A1-5 の 0:02:15-0:02:25 が順に結合されます。

切り抜き順序にあわせて、各行を移動したり複製したりできます。

動画内の見出しとして、「A1-1_2023/01/01」というような文字列が動画の各切抜き内で表示されます。

また、E1-1, I1-1, A1-5 は動画内にカウンターが表示されます。それぞれ、100 -> 102, 102 -> 105, 105 -> 106 というように、指定時刻で1ずつ加算されます。

カウンターの指定時刻について。  
E1-1 では、`1:20:10,15,30` は `1:20:10,1:20:15,1:20:30` の指定と同等で、1:20:15,1:20:30 の2回カウンターが加算されます。`15,30` は時間と分が省略されているため、秒数が一致していて1つ前の時刻から最も近い時刻に自動変換されます。  
I1-1 では、`1:10:05,2,1205,11306` は `1:10:05,1:11:2,1:12:05,1:13:06` の指定と同等です。`2` は時間と分が省略され、`1205` は時間が省略されています。

空行やメモについて、記載しても問題なく、無視されます。

タイムスタンプについて、以下のように出力されます。YouTubeのタイムスタンプに対応しています。
```
0:00:00 1. A1-1_2023/01/01 https://youtu.be/AAAAAAAAAAA?t=135s
0:00:10 1-2. A1-2_2023/01/01 https://youtu.be/AAAAAAAAAAA?t=145s
0:00:20 categoryX1. E1-1_2024/01/01 https://youtu.be/EEEEEEEEEEE?t=4810s
0:00:45 categoryX2. I1-1_2024/01/01 https://youtu.be/IIIIIIIIIII?t=4205s
0:03:48 categoryX3. I2-1_2024/01/01 https://youtu.be/IIIIIIIIIII?t=7200s
0:08:28 1. A1-5_2023/01/01 https://youtu.be/AAAAAAAAAAA?t=135s
```

URLのパラメータは切り抜き開始時刻が指定されます。  
採番はカテゴリごとです。また、A1-1 と A1-2 は切り抜き位置が近いので1つに分類され、1, 1-2 というように連番で採番されます。カテゴリが変われば採番も1からになります。  
`A1-1_2023/01/01` 等の部分は任意の文字列が指定可能で、タイムスタンプと動画内のどちらにも書かれます。改行や空白を書きたい場合、改行は `\n` で、空白は `\s` で指定できます。タイムスタンプでは改行は無視されます。

標準出力として、以下が出力されます。
```
count clip: 6
count memo: 11
```

切り抜き対象行の6行が count clip として出力されます。
E1-1, I1-1, A1-5 のカウンター更新時刻6箇所と、I2-1 の行頭メモの 5 の合計値が count memo として出力されます。

#### 3. 動画ダウンロード、動画編集 (、チャット数とスパチャ額集計)
```source src/video.sh 作成したディレクトリのパス オプション```

- 必須引数(1個): 作成したディレクトリのパス
- オプション: -a (動画全編をダウンロードする場合), -d (ダウンロードした元動画を削除する場合)

`-a` を指定すると、切り抜き箇所を含む元動画が全編ダウンロードされます。デフォルトでは、切り抜き付近のみがダウンロードされます。  
`-d` を指定すると、切り抜き作成後に元動画を削除します。ダウンロード、切り抜き作成、元動画削除という一連の流れが各動画ごとに実行されます。

ダウンロードされた動画は、 `作成したディレクトリのパス/download/` 内に保存されます。  
各切り抜きは、 `作成したディレクトリのパス/clip/` 内に保存されます。  
完成動画は `作成したディレクトリのパス/dst/clip.mp4` に出力されます。  
タイムスタンプは `作成したディレクトリのパス/dst/timestamp.txt` に出力されます。

動画内には、元動画タイトル、動画投稿日、関連チャット数、関連コメント数、スパチャ総額、カテゴリ、カウンターが表示されます。

##### 切り抜き箇所の修正
切り抜きのタイミングをずらしたい場合、以下の手順で修正できます。

1. `results.txt` の開始時刻と終了時刻を修正
1. 手順3のコマンドを再度実行 `source src/video.sh 作成したディレクトリのパス`

#### その他
##### シンボリックリンクの活用
本ツールでは処理するデータ量が非常に大きいため、ストレージ容量を圧迫する可能性があります。  
その場合、外付けHDD等を使用することができます。

外部ストレージを使う場合、直接パスを指定する以外にも、シンボリックリンクを作成する方法があります。

例 (外部ストレージが `/mnt/d/` にマウントされている場合)  
```ln -s /mnt/d/example data/20240510_example```  
```ln -s /mnt/d/example data/20240510_example/download```

##### 複数チャンネルの切り抜き
複数のチャンネルにまたがる切り抜きを作成する場合、以下の手順で作成可能です。

###### 1. すべてのチャンネルのチャットを取得
```source src/chat.sh data/example_sub0 AAAAAAAAAAA```  
```source src/chat.sh data/example_sub1 BBBBBBBBBBB```  
...

###### 2. チャットを1つのディレクトリにまとめる
```mkdir -p data/example_main/live_chat```

```mv data/example_sub0/live_chat/* data/example_main/live_chat/```  
```mv data/example_sub1/live_chat/* data/example_main/live_chat/```  
...

###### 3. 作成したディレクトリに対して手順1から順に実行
```source src/chat.sh data/example_main aaa 検索文字列(厳しめ) 検索文字列(緩め)```  
`results.txt` を編集  
```source src/video.sh data/example_main オプション```

## 使用例、コード解説
詳細は以下の記事に記載しています。

[https://diary-039.com/entry/2024/02/20/youtube-clip-automation](https://diary-039.com/entry/2024/02/20/youtube-clip-automation)

## 更新履歴

| 日付 | ver. | 更新内容 |
| --- | --- | --- |
| 2025/01/19 | v1.6.0 | 動画URL一覧の出力後にそれを参照して時系列順にチャットをダウンロードするよう変更(既存チャットの重複ダウンロード防止)、チャットの判定段階を1段階追加、カウンターのヘッダにカテゴリ名を表示するよう変更、MoviePy v2.X移行対応 |
| 2024/11/11 | v1.5.0 | 結合部ノイズ除去追加、カウンター表示機能追加、カウンター機能に伴ったresults.txtの記述方法追加、タイムスタンプでカテゴリごとに採番する機能追加、フォントファイル名に依存しないよう変更、日ごとのタイムスタンプ出力機能追加、生成過程の動画の削除可否を引数で指定するよう変更 |
| 2024/08/18 | v1.4.0 | チャットデータのダウンロード時にもCookieファイルを参照するよう変更、動画全編ダウンロード時にCookieファイルが参照されない問題の修正、月ごとと年ごとのタイムスタンプ出力機能追加 |
| 2024/07/31 | v1.3.0 | 音量正規化機能追加、シンボリックリンクでフォントファイルが読み込まれない問題の修正、完成動画の一時ファイルを削除するよう変更、各動画出力後のメモリ解放を明示的に指定、タイムスタンプを先に出力するよう変更、動画合計時間と現在の動画処理時間の標準出力機能追加、results.txtの行頭に回数メモ機能追加、results.txtにコメントアウトの行を入れられるよう変更、動画全編読み込み時のエラー修正、Cookieファイルによりログイン状態で処理できるよう修正 |
| 2024/06/12 | v1.2.0 | 切り抜き周辺のみのダウンロード機能追加、最高品質がmp4以外の場合に対応、タイムスタンプの同一事象連番対応 |
| 2024/05/19 | v1.1.0 | タイムスタンプの誤差が累積する問題の修正、表示日付を投稿日から公開日に変更、公開日を任意の文字列に編集できるよう変更(list_date_title.txtの必須化) |
| 2024/05/10 | v1.0.0 | 大幅改修(sum_superchat.pyの削除(video.shの検索文字列不要化)、文字列検索のpython完結化、results.txtへの全情報集約化、クラスタリングアルゴリズム一部変更(sum_superchat.py削除による、該当チャット直前数秒間のチャット取得のためのリングバッファ追加)、タイトル表示機能追加、切り抜き並べ替え対応、各切り抜き動画ファイル名のmsec化(時刻編集時に以前の切り抜きの削除不要化)、異なるアスペクト比の結合対応、ディレクトリのシンボリックリンク対応、円以外の通貨50種対応、results.txtの空白行許容対応、results.txtの上書き防止、ImageMagickとMoviePyのエラー回避、音のフェード対応) |
| 2024/03/10 | | コメントからの候補抽出機能追加、該当コメント数表示対応、時刻の小数対応 |
| 2024/02/27 | | チャットダウンロードのみの実行機能追加 |
| 2024/02/22 | | チャット取得時に前半の一部しか取得されない問題の修正、ダウンロード再試行回数指定機能追加、ダウンロード失敗時のエラー回避 |
| 2024/02/20 | | 初版として公開 |
| 2024/02/11 | | 簡易版完成、初試用 |
| 2024/02/10 | | 開発開始 |
